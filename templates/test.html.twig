{% extends "inline.html.twig" %}

{% block main %}

	<div class="col-12 d-flex justify-content-center text-center mt-5">
		<div class="col-12 col-md-3">
			<div class="row">
				{% set break = false %}
				{% for invitation in app.user.invitations | sort ((a, b) => a.event.date <=> b.event.date ) %}
					{% if invitation.accepted == true and invitation.refused == false and (invitation.event.date > date('now')) and break == false %}
						<div class="cards shadows">
							<div class="cardHeader col-12 bgColorOne">
								<p>Prochaine invitation : ceci est un test
									{{invitation.event.theme|upper}}</p>
							</div>

							<div class="cardBody col-12">
								{% if app.user.invitations is empty %}
									<p>
										Vous n'avez pas d'invitation.</p>
									<p class="my-3">votre prochaine invitation apparaitra ici!</p>
								{% else %}
									<p class="card-title text-muted">Organisé par :
										{{invitation.event.owner.firstName|title}}</p>
									<p class="card-title">Le
										{{invitation.event.date|format_datetime('full','short', locale='fr')}}</p>
								{% endif %}
							</div>

							<div class="cardFooter col-12">
								<div class="row">
									<div class="col-6 leftBtn bgColorOne">
										<a href="{{path('contribution_add',{'eventId':invitation.event.id})}}">Contribuer</a>
									</div>
									<div class="col-6 rightBtn bgColorOne">
										<a href="{{path("event_show", {'userId': user.id})}}">Autres invitations</a>
									</div>
								</div>
							</div>
						</div>
						{% set break = true %}
					{% endif %}
				{% endfor %}
			</div>


			{# ------------------------------------------------------ Prochaine Invitation ------------------------------------------------------ #}
			<div class="col-12">
				{% if app.user.invitations is empty %}
					<div class="alert alert-light text-center">
						<p class="mb-0">Prochaine invitation</p>
						<hr>
						<p>
							Vous n'avez pas d'invitations en cours!
						</p>
						<p class="my-3">votre prochaine invitation apparaitra ici!</p>
					</div>
				{% elseif app.user.invitations is not empty %}
					{% set break = false %}
					{% for invitation in app.user.invitations | sort ((a, b) => a.event.date <=> b.event.date ) %}
						{% if invitation.accepted == true and invitation.refused == false and (invitation.event.date > date('now')) and break == false %}
							<div class="card shadow-sm p-1 bg-white rounded">
								<div class="card-header invitation">
									<p class="h6 pt-1">Prochaine invitation:
										{{invitation.event.theme|upper}}</p>
								</div>
								<div class="card-body">
									<p class="card-title text-muted">Organisé par :
										{{invitation.event.owner.firstName|title}}</p>
									<p class="card-title">Le
										{{invitation.event.date|format_datetime('full','short', locale='fr')}}</p>
									<a href="{{path('contribution_add',{'eventId':invitation.event.id})}}">
										<button class="btn btn-sm">Apporter une contribution</button>
									</a>
								</div>
							</div>
							{% set break = true %}
						{% endif %}
					{% endfor %}
				{% endif %}

				<a class="badge rounded col" href="{{ path('invitation_showAll')}}">+ Toutes vos invitations à venir</a>

				{#Vérifier s'il ya une nouvelle invitation non consultée#}

				{% set invitations = app.user.invitations | filter (invitation => invitation.event.date > date('now'))  %}
				{% set invitations = invitations | filter (invitation => invitation.sent and invitation.accepted == false ) %}
				{% set invitations = invitations | sort((a, b) => a.event.date <=> b.event.date) %}
				{% set newInvitation = invitations | first %}
				{% if newInvitation %}
					<a class="badge badge-warning rounded text-white col-md-5" href="{{ path('invitation_showAll') }}">En attente de reponse!</a>
				{% endif %}

			</div>


			{# ------------------------------------------------------ Prochaine organisation ------------------------------------------------------ #}

			<hr class="my-2">

			<div class="col-12">
				{% if app.user.events is empty %}
					<div class="alert alert-light text-center">
						<p class="mb-0">Prochain évènement
						</p>
						<hr>
						<p>
							Vous n'avez pas d'évènements en cours!
						</p>
						<a href="{{ path('event_register')}}" class="btn my-3">Créer votre 1er évènement</a>
					</div>
				{% else %}
					{% set break = false %}
					{% for event in app.user.events | sort((a, b) => a.date <=> b.date) %}
						{% if (event.date > date('now')) and break == false %}
							<div class="card shadow-sm p-1 bg-white rounded">
								<div class="card-header event">
									<p class="h6 pt-1">Prochain évènement:
										{{event.theme|upper}}</p>
								</div>
								<div class="card-body">
									<p class="card-title text-muted">Organisé par : Vous</p>
									<p class="card-title">Le
										{{event.date|format_datetime('full','short', locale='fr')}}</p>
									<a href="{{path('guest_add', {'eventId': event.id})}}">
										<button class="btn btn-sm my-1">Vos invités</button>
									</a>
									{{path("event_show", {'userId': user.id})}}
									<a href="{{path('contribution_add', {'eventId': event.id})}}">
										<button class="btn btn-sm my-1">Voir la carte</button>
									</a>
								</div>
							</div>
							{% set break = true %}
						{% endif %}
					{% endfor %}
					<div>
						<a class="badge rounded  col mt-2" href="">
							+ Voir toutes vos évènements</a>
					</div>
				{% endif %}
			</div>
			<hr class="my-2 border-0">


		</div>

		{# ------------------------------------------------------ galerie Photo ------------------------------------------------------ #}

		<div class="col-12 col-md-4">


			<div>

				<div class="card mb-3 shadow-sm p-1 mb-1 rounded text-center">
					<h4 class="card-header">Votre album photo</h4>
					<div class="card-body">
						<h6 class="card-title">Consultez et partagez les images de toutes vos participations</h6>
					</div>

					<div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
						<div class="carousel-inner">
							{% if user.media is empty %}
								<div class="carousel-item">
									<img src="/uploads/easter.jpg" class="d-block w-100" alt="...">
								</div>
							{% endif %}
							{% for invitation in user.invitations %}
								{% for medium in invitation.event.media %}
									<div class="carousel-item {{ loop.first ? " active" : " " }} ">
										<img src="{{medium.url}}" class="d-block w-100" alt="...">
									</div>
								{% endfor %}
							{% endfor %}
						</div>
						<a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
							<span class="carousel-control-prev-icon" aria-hidden="true"></span>
							<span class="sr-only">Previous</span>
						</a>
						<a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
							<span class="carousel-control-next-icon" aria-hidden="true"></span>
							<span class="sr-only">Next</span>
						</a>
					</div>


					<div
						class="card-footer text-muted">
					</div>
				</div>

				

			</div>

		</div>

		{# ------------------------------------------------------ Evénement précedement ------------------------------------------------------ #}

		<div class="col-12 col-md-3">
			<div>
				{% set invitations = app.user.invitations %}
				{% set invitations = invitations | filter (invitation => invitation.event.date < date('now')) %}
				{% set invitations = invitations | filter (invitation => invitation.accepted) %}
				{% set invitations = invitations | sort ((a, b) => a.event.date <=> b.event.date) %}
				{% set lastInvitation = invitations | first %}

				{% set events = app.user.events %}
				{% set events = events | filter (event => event.date < date('now')) %}
				{% set events = events | sort ((a, b) => a.date <=> b.date) %}
				{% set lastEvent = events | first %}

				{% if not lastInvitation and not lastEvent %}
					<div class="alert alert-light text-center">
						<strong class="warning">Pour l'heure, vous n'avez participé à aucun évènement!</strong>
					</div><br>

				{% else %}

					{% if not lastInvitation %}
						{% set eventDisplay = lastEvent %}

					{% elseif not lastEvent %}
						{% set eventDisplay = lastInvitation.event %}

					{% else %}
						{% set eventDisplay = (lastEvent.date < lastInvitation.event.date ? lastInvitation.event : lastEvent) %}
					{% endif %}

					{# ------------------------------------------------------ boucle sur les invitations ------------------------------------------------------ #}
					<div class="card shadow-sm p-1 mb-1 rounded">
						<div class="card-header">
							<p class="h6 pt-1">Vous avez participé à l'évènement :
								{{eventDisplay.theme|upper}}</p>
						</div>
						<div class="card-body">
							<p class="card-title text-muted">Organisé par :
								{{eventDisplay.owner.firstName|title}}</p>
							<p class="card-title">Le
								{{eventDisplay.date|format_datetime('full','short', locale='fr')}}</p>
							<a href="#">
								<button class="btn btn-sm my-1" data-toggle="tooltip" data-placement="bottom" title="Partie en cours de développement" disabled>laisser un commentaire</button>
							</a>
							<a href="{{path('media_add',{'eventId':eventDisplay.id})}}">
								<button class="btn btn-sm px-4 my-1">Partager des images</button>
							</a>
						</div>
					</div>
				{% endif %}
			</div>
			<div><hr></div>
		</div>

		{# ------------------------------------------------------ the end ------------------------------------------------------ #}
	</div>
{% endblock %}
